<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couchbase Document Key Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981'
                    }
                }
            }
        }
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LL3LWXVBHR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-LL3LWXVBHR');
    </script>

</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">
                Couchbase Document Key Builder
            </h1>
            
            <!-- Environment Selection -->
            <div class="mb-6">
                <label for="environment" class="block text-sm font-medium text-gray-700 mb-2">Environment</label>
                <select id="environment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">Select Environment</option>
                    <option value="trunk" data-prefix="mxhk">Trunk (mxhk:)</option>
                    <option value="qa" data-prefix="mxqa">QA (mxqa:)</option>
                    <option value="prod" data-prefix="mx">Production (mx:)</option>
                </select>
                
                <!-- Couchbase UI Link -->
                <div id="couchbaseLink" class="mt-2 hidden">
                    <a id="couchbaseUrl" href="#" target="_blank" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 transition-colors duration-200">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Open Couchbase UI
                    </a>
                </div>
            </div>

            <!-- Document Type Selection -->
            <div class="mb-6">
                <label for="docType" class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                <select id="docType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">Select Document Type</option>
                    <optgroup label="Player Documents">
                        <option value="s" data-params="psaId">Player Saga (s:psaId)</option>
                        <option value="sz" data-params="psaId,sagaZoneId">Player Saga Zone (sz:psaId:sagaZoneId)</option>
                        <option value="q" data-params="psaId,questId">Player Quest (q:psaId:questId)</option>
                        <option value="qc" data-params="psaId,questCampaignId">Player Quest Campaign (qc:psaId:questCampaignId)</option>
                        <option value="qs" data-params="psaId">Player Quest States (qs:psaId)</option>
                        <option value="ct" data-params="psaId">Player Counters (ct:psaId)</option>
                        <option value="co" data-params="psaId">Player Consumables (co:psaId)</option>
                        <option value="se" data-params="psaId">Player Seasons (se:psaId)</option>
                        <option value="c" data-params="psaId">Collections (c:psaId)</option>
                        <option value="sm" data-params="psaId">Spin Meta (sm:psaId)</option>
                        <option value="pb" data-params="psaId">Purchase Bonus (pb:psaId)</option>
                        <option value="mvq" data-params="psaId">MyVegas Quest (mvq:psaId)</option>
                        <option value="pcheats" data-params="psaId">Player Cheats (pcheats:psaId)</option>
                        <option value="PlayerCampaign" data-params="psaId">Player Campaign (PlayerCampaign:psaId)</option>
                        <option value="pc" data-params="psaId">Daily Bonus Game State (pc:psaId)</option>
                        <option value="pi" data-params="psaId">Player Inbox (pi:psaId)</option>
                        <option value="ls" data-params="psaId">Leaderboard State (ls:psaId)</option>
                        <option value="pg" data-params="psaId">Player Gifts (pg:psaId)</option>
                        <option value="in" data-params="psaId">Inventory (in:psaId)</option>
                    </optgroup>
                    <optgroup label="Album Documents">
                        <option value="alp" data-params="psaId">Album Progress (alp:psaId)</option>
                        <option value="alpv2" data-params="psaId">Album Progress V2 (alpv2:psaId)</option>
                        <option value="alrb" data-params="psaId">Album Reward Booster (alrb:psaId)</option>
                        <option value="albums" data-params="psaId,albumId">Player Albums (albums:psaId:albumId)</option>
                    </optgroup>
                    <optgroup label="Glados Documents">
                        <option value="g2:pa" data-params="psaId">Glados2 Preview Award (g2:pa:psaId)</option>
                        <option value="g2i" data-params="psaId">Glados2 Index (g2i:psaId)</option>
                        <option value="g2" data-params="system,psaId">Glados2 (g2:system:psaId)</option>
                    </optgroup>
                    <optgroup label="Other Documents">
                        <option value="si" data-params="scheduleId,psaId">Schedule Instance (si:scheduleId:psaId)</option>
                        <option value="gctm" data-params="counterId">Global Counter Meta (gctm:counterId)</option>
                        <option value="gs" data-params="sessionId">Player Gifts Sent (gs:sessionId)</option>
                    </optgroup>
                </select>
            </div>

            <!-- Dynamic Parameter Inputs -->
            <div id="parameterInputs" class="space-y-4 mb-6">
                <!-- Dynamic inputs will be generated here -->
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="mb-6">
                <div class="bg-gray-50 rounded-lg p-6 border">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Generated Document Key</h3>
                    <div class="bg-white p-4 rounded border font-mono text-lg break-all min-h-[3rem] flex items-center" id="generatedKey">
                        <span class="text-gray-400 italic">Select environment and document type to generate key</span>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button id="copyBtn" class="bg-secondary text-white px-4 py-2 rounded hover:bg-secondary/90 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Copy to Clipboard
                        </button>
                        <button id="clearBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors duration-200">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CouchbaseKeyBuilder {
            constructor() {
                this.selectedPrefix = null;
                this.couchbaseUrls = {
                    'trunk': 'http://10.112.64.108:8091/ui/index.html#/docs/editor?commonBucket=mvmx_arthur_trunk_ephemeral&scenarioZoom=minute&scenario=zl7an9ein',
                    'qa': 'http://10.176.0.223:8091/ui/index.html#/docs/editor?commonBucket=mvmx_arthur_qa&scenarioZoom=minute&scenario=oonar29lw',
                    'prod': 'http://couch001.ps2.int:8091/ui/index.html#/docs/editor?commonBucket=mvmx_backend_production&scenarioZoom=minute&scenario=jip4ztbz2'
                };
                this.initializeEventListeners();
                this.loadSavedValues();
            }

            initializeEventListeners() {
                // Environment selection
                document.getElementById('environment').addEventListener('change', (e) => this.handleEnvironmentChange(e));

                // Document type selection
                document.getElementById('docType').addEventListener('change', (e) => this.handleDocTypeChange(e));

                // Copy button
                document.getElementById('copyBtn').addEventListener('click', () => this.copyToClipboard());

                // Clear button
                document.getElementById('clearBtn').addEventListener('click', () => this.clearForm());
            }

            handleEnvironmentChange(e) {
                const selectedOption = e.target.selectedOptions[0];
                const environment = e.target.value;
                this.selectedPrefix = selectedOption.dataset.prefix || null;
                
                // Show/hide Couchbase UI link
                const linkContainer = document.getElementById('couchbaseLink');
                const linkElement = document.getElementById('couchbaseUrl');
                
                if (environment && this.couchbaseUrls[environment]) {
                    linkElement.href = this.couchbaseUrls[environment];
                    linkContainer.classList.remove('hidden');
                } else {
                    linkContainer.classList.add('hidden');
                }
                
                this.saveValues();
                this.generateKey();
            }

            handleDocTypeChange(e) {
                const selectedOption = e.target.selectedOptions[0];
                const params = selectedOption.dataset.params;
                
                this.generateParameterInputs(params);
                this.saveValues();
                this.generateKey();
            }

            generateParameterInputs(params) {
                const container = document.getElementById('parameterInputs');
                container.innerHTML = '';

                if (!params) return;

                const paramList = params.split(',');
                paramList.forEach(param => {
                    const div = document.createElement('div');
                    
                    // Special handling for 'system' parameter - use dropdown for Award System
                    if (param === 'system') {
                        div.innerHTML = `
                            <label for="${param}" class="block text-sm font-medium text-gray-700 mb-2">${this.formatParamLabel(param)}</label>
                            <select id="${param}" name="${param}"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Select Award System</option>
                                <option value="None">None</option>
                                <option value="Rollback">Rollback</option>
                                <option value="Inbox">Inbox</option>
                                <option value="Admon">Admon</option>
                                <option value="Purchase">Purchase</option>
                                <option value="PurchaseBonus">PurchaseBonus</option>
                                <option value="Gifting">Gifting</option>
                                <option value="SeasonItemExpired">SeasonItemExpired</option>
                                <option value="QuestMilestoneComplete">QuestMilestoneComplete</option>
                                <option value="QuestComplete">QuestComplete</option>
                                <option value="QuestEnd">QuestEnd</option>
                                <option value="QuestCampaignComplete">QuestCampaignComplete</option>
                                <option value="CounterGoal">CounterGoal</option>
                                <option value="SibylAction">SibylAction</option>
                                <option value="DailyBonus">DailyBonus</option>
                                <option value="HourlyBonus">HourlyBonus</option>
                                <option value="GoBroke">GoBroke</option>
                                <option value="Coupon">Coupon</option>
                                <option value="LevelUp">LevelUp</option>
                                <option value="FacebookLogin">FacebookLogin</option>
                                <option value="Teak">Teak</option>
                                <option value="CounterManipulate">CounterManipulate</option>
                                <option value="TimedCollect">TimedCollect</option>
                                <option value="GameSpin">GameSpin</option>
                                <option value="Preview">Preview</option>
                                <option value="Inventory">Inventory</option>
                                <option value="Album">Album</option>
                                <option value="Leaderboard">Leaderboard</option>
                            </select>
                        `;
                        container.appendChild(div);

                        // Add event listener for select changes
                        const select = div.querySelector('select');
                        select.addEventListener('change', () => {
                            this.saveValues();
                            this.generateKey();
                        });
                    } else {
                        // Regular text input for other parameters
                        div.innerHTML = `
                            <label for="${param}" class="block text-sm font-medium text-gray-700 mb-2">${this.formatParamLabel(param)}</label>
                            <input type="text" id="${param}" name="${param}"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="Enter ${param}">
                        `;
                        container.appendChild(div);

                        // Add event listener for input changes
                        const input = div.querySelector('input');
                        input.addEventListener('input', () => {
                            this.saveValues();
                            this.generateKey();
                        });
                    }
                });

                // Load saved parameter values
                this.loadParameterValues();
            }

            formatParamLabel(param) {
                const labels = {
                    'psaId': 'PSA ID',
                    'sagaZoneId': 'Saga Zone ID',
                    'questId': 'Quest ID',
                    'questCampaignId': 'Quest Campaign ID',
                    'albumId': 'Album ID',
                    'scheduleId': 'Schedule ID',
                    'counterId': 'Counter ID',
                    'sessionId': 'Session ID',
                    'system': 'Award System'
                };
                return labels[param] || param;
            }

            generateKey() {
                const environment = document.getElementById('environment').value;
                const docType = document.getElementById('docType').value;
                const paramInputs = document.querySelectorAll('#parameterInputs input');
                const paramSelects = document.querySelectorAll('#parameterInputs select');
                const keyDisplay = document.getElementById('generatedKey');
                const copyBtn = document.getElementById('copyBtn');
                
                // Check if we have minimum requirements
                if (!environment || !docType) {
                    keyDisplay.innerHTML = '<span class="text-gray-400 italic">Select environment and document type to generate key</span>';
                    copyBtn.disabled = true;
                    return;
                }

                // Check if all required parameters are filled (both inputs and selects)
                const allInputsFilled = Array.from(paramInputs).every(input => input.value.trim() !== '');
                const allSelectsFilled = Array.from(paramSelects).every(select => select.value.trim() !== '');
                const totalParams = paramInputs.length + paramSelects.length;
                
                if (totalParams > 0 && (!allInputsFilled || !allSelectsFilled)) {
                    keyDisplay.innerHTML = '<span class="text-gray-400 italic">Fill in all parameters to generate key</span>';
                    copyBtn.disabled = true;
                    return;
                }

                // Generate the key
                let keyParts = [docType];
                
                // Add values from both inputs and selects in the order they appear
                const allElements = document.querySelectorAll('#parameterInputs input, #parameterInputs select');
                allElements.forEach(element => {
                    keyParts.push(element.value.trim());
                });
                
                const documentKey = keyParts.join(':');
                const fullKey = `${this.selectedPrefix}:${documentKey}`;
                
                keyDisplay.textContent = fullKey;
                copyBtn.disabled = false;
            }

            copyToClipboard() {
                const keyText = document.getElementById('generatedKey').textContent;
                if (keyText && !keyText.includes('Select') && !keyText.includes('Fill')) {
                    navigator.clipboard.writeText(keyText).then(() => {
                        const btn = document.getElementById('copyBtn');
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        btn.classList.remove('bg-secondary');
                        btn.classList.add('bg-green-500');
                        
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.classList.remove('bg-green-500');
                            btn.classList.add('bg-secondary');
                        }, 2000);
                    });
                }
            }

            clearForm() {
                // Clear form fields
                document.getElementById('environment').value = '';
                document.getElementById('docType').value = '';
                document.getElementById('parameterInputs').innerHTML = '';
                
                // Hide Couchbase link
                document.getElementById('couchbaseLink').classList.add('hidden');
                
                const keyDisplay = document.getElementById('generatedKey');
                keyDisplay.innerHTML = '<span class="text-gray-400 italic">Select environment and document type to generate key</span>';
                
                document.getElementById('copyBtn').disabled = true;
                
                this.selectedPrefix = null;
                
                // Clear localStorage
                localStorage.removeItem('couchbaseKeyBuilder');
            }

            saveValues() {
                const data = {
                    environment: document.getElementById('environment').value,
                    docType: document.getElementById('docType').value,
                    parameters: {}
                };

                // Save parameter values from both inputs and selects
                document.querySelectorAll('#parameterInputs input, #parameterInputs select').forEach(element => {
                    data.parameters[element.name] = element.value;
                });

                localStorage.setItem('couchbaseKeyBuilder', JSON.stringify(data));
            }

            loadSavedValues() {
                const saved = localStorage.getItem('couchbaseKeyBuilder');
                if (!saved) return;

                try {
                    const data = JSON.parse(saved);
                    
                    // Restore environment selection
                    if (data.environment) {
                        document.getElementById('environment').value = data.environment;
                        const event = new Event('change');
                        document.getElementById('environment').dispatchEvent(event);
                    }

                    // Restore document type
                    if (data.docType) {
                        document.getElementById('docType').value = data.docType;
                        const event = new Event('change');
                        document.getElementById('docType').dispatchEvent(event);
                    }

                    // Restore parameters will be handled by loadParameterValues
                    this.savedParameters = data.parameters || {};
                } catch (e) {
                    console.error('Error loading saved values:', e);
                }
            }

            loadParameterValues() {
                if (!this.savedParameters) return;

                Object.entries(this.savedParameters).forEach(([name, value]) => {
                    const element = document.getElementById(name);
                    if (element) {
                        element.value = value;
                    }
                });

                this.generateKey();
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new CouchbaseKeyBuilder();
        });
    </script>
</body>
</html>