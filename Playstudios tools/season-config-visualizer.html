<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sibyl Logic Inspector</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Mermaid for Flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-code { font-family: 'Fira Code', monospace; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Pan/Zoom cursor styles */
        .grab-cursor { cursor: grab; }
        .grabbing-cursor { cursor: grabbing; }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LL3LWXVBHR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-LL3LWXVBHR');
    </script>

</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        const STORAGE_KEY = 'sibyl_logic_data';

        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: { 
                useMaxWidth: false, 
                htmlLabels: true,
                curve: 'basis' 
            } 
        });

        // --- 1. Helper Components ---

        const ExpressionHighlighter = ({ expr }) => {
            if (expr === null || expr === undefined) return <span className="text-slate-600 italic">null</span>;
            if (typeof expr !== 'string') return <span className="text-yellow-400">{String(expr)}</span>;

            const parts = expr.split(/('[\s\S]*?'|[\(\),])/g);

            return (
                <span className="font-code text-xs break-all leading-relaxed">
                    {parts.map((part, i) => {
                        if (part.startsWith("'")) return <span key={i} className="text-green-400">{part}</span>;
                        if (!isNaN(parseFloat(part)) && isFinite(part)) return <span key={i} className="text-orange-400">{part}</span>;
                        if (['(', ')', ','].includes(part)) return <span key={i} className="text-slate-500 font-bold">{part}</span>;
                        if (['Ctr', 'TableD', 'TableL', 'TableS', 'TagD', 'TagL', 'GetTier', 'HasCounter', 'StrContain', 'CastString', 'DayIndexOfSeason', 'IsSeasonActive'].includes(part.trim())) return <span key={i} className="text-blue-400 font-bold">{part}</span>;
                        if (['if', 'and', 'or', 'MinD', 'MaxD', 'Min', 'Max', 'Round', 'RoundSig', 'RandomInt', 'RandomIndexByWeights'].includes(part.trim())) return <span key={i} className="text-purple-400 font-bold">{part}</span>;
                        return <span key={i} className="text-slate-300">{part}</span>;
                    })}
                </span>
            );
        };

        // --- 2. Pan/Zoom Wrapper (Fixed for Passive Events) ---

        const PanZoomContainer = ({ children, contentKey }) => {
            const [transform, setTransform] = useState({ x: 0, y: 0, scale: 1 });
            const [isDragging, setIsDragging] = useState(false);
            const containerRef = useRef(null);
            const lastPos = useRef({ x: 0, y: 0 });

            useEffect(() => {
                setTransform({ x: 0, y: 0, scale: 1 });
            }, [contentKey]);

            // Fix: Attach wheel listener non-passively to allow preventDefault
            useEffect(() => {
                const node = containerRef.current;
                if (!node) return;

                const onWheel = (e) => {
                    e.preventDefault();
                    const scaleSensitivity = 0.001;
                    const newScale = Math.min(Math.max(0.1, transform.scale - e.deltaY * scaleSensitivity), 5);
                    setTransform(prev => ({ ...prev, scale: newScale }));
                };

                node.addEventListener('wheel', onWheel, { passive: false });
                return () => node.removeEventListener('wheel', onWheel);
            }, [transform.scale]); // Re-bind if needed, or use ref for scale

            const handleMouseDown = (e) => {
                if (e.button !== 0) return; // Left click only
                setIsDragging(true);
                lastPos.current = { x: e.clientX, y: e.clientY };
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const dx = e.clientX - lastPos.current.x;
                const dy = e.clientY - lastPos.current.y;
                lastPos.current = { x: e.clientX, y: e.clientY };
                setTransform(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
            };

            const handleMouseUp = () => setIsDragging(false);
            const handleMouseLeave = () => setIsDragging(false);

            const reset = () => setTransform({ x: 0, y: 0, scale: 1 });

            return (
                <div 
                    ref={containerRef}
                    className={`relative w-full h-full overflow-hidden bg-slate-950 ${isDragging ? 'grabbing-cursor' : 'grab-cursor'}`}
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseLeave}
                >
                    <div 
                        style={{ 
                            transform: `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`,
                            transformOrigin: 'center',
                            transition: isDragging ? 'none' : 'transform 0.1s ease-out'
                        }}
                        className="w-full h-full flex items-center justify-center"
                    >
                        {children}
                    </div>
                    
                    {/* Controls */}
                    <div className="absolute bottom-4 right-4 flex gap-2 z-10">
                        <button onClick={() => setTransform(t => ({ ...t, scale: Math.min(5, t.scale + 0.2) }))} className="bg-slate-800 text-white p-2 rounded shadow border border-slate-700 hover:bg-slate-700 font-bold">+</button>
                        <button onClick={() => setTransform(t => ({ ...t, scale: Math.max(0.1, t.scale - 0.2) }))} className="bg-slate-800 text-white p-2 rounded shadow border border-slate-700 hover:bg-slate-700 font-bold">-</button>
                        <button onClick={reset} className="bg-slate-800 text-white px-3 py-2 rounded shadow border border-slate-700 hover:bg-slate-700 text-xs uppercase font-bold">Reset</button>
                    </div>
                    <div className="absolute bottom-4 left-4 text-slate-500 text-xs pointer-events-none select-none">
                        Scroll to Zoom ‚Ä¢ Drag to Pan
                    </div>
                </div>
            );
        };

        // --- 3. Card Components ---

        const KeyValueRow = ({ k, v, onLinkClick }) => {
            const isLink = (k === 'ActionDefinitionId' || k === 'NextEventId' || k === 'AwardId');
            
            return (
                <div className="flex flex-col sm:flex-row sm:gap-2 border-b border-slate-700/50 last:border-0 py-1">
                    <span className="text-[10px] text-slate-500 uppercase font-bold min-w-[120px] pt-0.5">{k}</span>
                    <div className="flex-1 font-code text-xs text-slate-300 break-all">
                        {isLink ? (
                            <button 
                                onClick={() => onLinkClick && onLinkClick(v)}
                                className="text-blue-300 hover:text-blue-100 hover:underline text-left w-full"
                            >
                                {v} <span className="text-[9px]">‚Üó</span>
                            </button>
                        ) : (
                            k.includes('Expression') ? <ExpressionHighlighter expr={v} /> : String(v)
                        )}
                    </div>
                </div>
            );
        }

        const ActionStep = ({ action, stepIndex, onLinkClick }) => {
            let typeColor = "bg-slate-700/50 border-slate-600/50";
            let icon = "üîß";
            let label = action.Type;

            if (action.Type === 'SetCounter') {
                typeColor = "bg-blue-900/20 border-blue-800/50";
                icon = "‚úèÔ∏è";
            } else if (action.Type === 'ResetCounter') {
                typeColor = "bg-red-900/20 border-red-800/50";
                icon = "üîÑ";
            } else if (action.Type === 'SibylAction') {
                typeColor = "bg-purple-900/20 border-purple-800/50";
                icon = "üîó";
                label = "Link Action";
            } else if (action.Type === 'Glados2Event') {
                typeColor = "bg-yellow-900/20 border-yellow-800/50";
                icon = "üéÅ";
                label = "Award";
            }

            const entries = Object.entries(action).filter(([k]) => k !== 'Type');

            return (
                <div className="relative pl-6 pb-6 last:pb-0 border-l border-slate-700 ml-2">
                    <div className="absolute -left-2.5 top-0 w-5 h-5 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center text-[10px] font-mono text-slate-400 shadow-sm">
                        {stepIndex + 1}
                    </div>
                    
                    <div className={`p-3 rounded-md border ${typeColor} mb-1 hover:bg-slate-800/80 transition-colors`}>
                        <div className="flex justify-between items-start mb-2 pb-2 border-b border-white/5">
                            <span className="font-bold text-xs flex items-center gap-2 text-white">
                                <span className="text-base">{icon}</span> 
                                <span className="uppercase tracking-wider opacity-90">{label}</span>
                            </span>
                        </div>

                        <div className="space-y-1">
                            {entries.map(([k, v]) => (
                                <KeyValueRow key={k} k={k} v={v} onLinkClick={onLinkClick} />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ActionDefinitionCard = ({ id, def, onLinkClick }) => {
            return (
                <div id={id} className="bg-slate-800 border border-slate-700 p-4 rounded-lg shadow-sm scroll-mt-20">
                    <div className="flex items-center justify-between mb-4 pb-2 border-b border-slate-700">
                        <div className="font-bold text-purple-300 text-sm font-code truncate pr-4" title={id}>{id}</div>
                        <div className="text-[10px] font-bold bg-slate-900 text-slate-400 px-2 py-1 rounded-full whitespace-nowrap">
                            {def.Actions?.length || 0} Steps
                        </div>
                    </div>

                    {def.Loop && (
                        <div className="mb-4 bg-fuchsia-900/20 border border-fuchsia-500/30 p-3 rounded-md">
                            <div className="text-[10px] text-fuchsia-400 font-bold uppercase mb-1 flex items-center gap-1">
                                <span>üîÑ</span> Loop Enabled
                            </div>
                            <div className="text-xs text-slate-300">
                                <span className="text-slate-500 mr-2">While:</span>
                                <ExpressionHighlighter expr={def.LoopCondition} />
                            </div>
                        </div>
                    )}

                    {def.ConditionExpression && !def.Loop && (
                         <div className="mb-4 bg-orange-900/10 border border-orange-500/30 p-3 rounded-md">
                            <div className="text-[10px] text-orange-400 font-bold uppercase mb-1">Global Pre-Condition</div>
                            <ExpressionHighlighter expr={def.ConditionExpression} />
                        </div>
                    )}

                    <div className="space-y-1">
                        {def.Actions?.map((action, i) => (
                            <ActionStep key={i} action={action} stepIndex={i} onLinkClick={onLinkClick} />
                        ))}
                        {(!def.Actions || def.Actions.length === 0) && <div className="text-slate-500 text-xs italic p-2">No actions defined.</div>}
                    </div>
                </div>
            );
        };

        const CounterCard = ({ id, def }) => {
            return (
                <div className="bg-slate-800 border border-slate-700 p-3 rounded-lg hover:border-blue-500/50 transition-all">
                    <div className="flex items-center justify-between mb-2">
                        <div className="font-bold text-blue-300 text-sm font-code truncate" title={id}>{id}</div>
                        {def.ClientVisible && <span className="text-[10px] bg-green-900/30 text-green-400 px-1.5 py-0.5 rounded border border-green-900/50">Visible</span>}
                    </div>
                    
                    <div className="space-y-2">
                        {def.StartingValueExpression !== undefined && (
                            <div className="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                <div className="text-[10px] uppercase text-slate-500 font-bold mb-1">Start Value</div>
                                <ExpressionHighlighter expr={def.StartingValueExpression} />
                            </div>
                        )}
                        {def.StartingValue !== undefined && (
                            <div className="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                <div className="text-[10px] uppercase text-slate-500 font-bold mb-1">Start Value (Static)</div>
                                <span className="font-code text-orange-400 text-xs">{def.StartingValue}</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EventCard = ({ id, def, onLinkClick }) => {
            return (
                <div className="bg-slate-800 border border-slate-700 p-4 rounded-lg hover:border-emerald-500/50 transition-all">
                    <div className="flex items-center justify-between mb-2">
                        <div className="font-bold text-emerald-300 text-sm font-code truncate" title={id}>{id}</div>
                        {def.Active && <span className="w-2 h-2 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/50"></span>}
                    </div>
                    
                    {def.CountActions && (
                        <div className="mt-3">
                            <div className="text-[10px] uppercase text-slate-500 font-bold mb-2">Triggered Actions</div>
                            <div className="space-y-2">
                                {def.CountActions.map((act, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => onLinkClick && onLinkClick(act.ActionDefinitionId)}
                                        className="w-full text-left bg-slate-900/50 p-2 rounded border border-slate-700/50 flex items-center gap-2 hover:bg-slate-700 hover:border-purple-500 transition-colors group"
                                    >
                                        <span className="text-purple-400 text-xs">‚ö°</span>
                                        <span className="text-xs font-code text-slate-300 break-all group-hover:text-purple-200 group-hover:underline">
                                            {act.ActionDefinitionId}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TableCard = ({ id, def }) => {
            const entries = def.Table ? Object.entries(def.Table) : [];
            const isLarge = entries.length > 5;
            const [showAll, setShowAll] = useState(!isLarge);

            return (
                <div className="bg-slate-800 border border-slate-700 p-4 rounded-lg">
                    <div className="font-bold text-orange-300 text-sm font-code mb-2 break-all" title={id}>{id}</div>
                    {def.Default !== undefined && (
                        <div className="text-xs text-slate-500 mb-2">Default: {def.Default}</div>
                    )}
                    
                    <div className="bg-slate-900 rounded overflow-hidden border border-slate-700">
                        <table className="w-full text-left text-xs font-mono">
                            <thead className="bg-slate-800 text-slate-400">
                                <tr>
                                    <th className="p-2 border-b border-slate-700">Key</th>
                                    <th className="p-2 border-b border-slate-700">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {entries.slice(0, showAll ? entries.length : 5).map(([k, v], i) => (
                                    <tr key={i} className="border-b border-slate-800 last:border-0">
                                        <td className="p-2 text-blue-300 border-r border-slate-800/50">{k}</td>
                                        <td className="p-2 text-slate-300">
                                            {typeof v === 'object' ? JSON.stringify(v) : String(v)}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {isLarge && (
                            <button 
                                onClick={() => setShowAll(!showAll)}
                                className="w-full py-1 text-[10px] text-slate-500 hover:bg-slate-800 transition-colors"
                            >
                                {showAll ? 'Show Less' : `Show All (${entries.length})`}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- 4. Flowchart Logic ---

        const generateMermaidGraph = (rootId, data, direction) => {
            if (!data) return { graph: '', nodeMap: {} };
            
            const actionDefinitions = {
                ...(data.SibylSystemCounters?.ActionDefinitions || {}),
                ...(data.ActionDefinitions || {})
            };

            const nodes = new Set();
            const edges = [];
            const visited = new Set();
            const idMap = {}; 
            const stepMeta = {}; 
            
            const getSafeId = (id) => {
                const safe = id.replace(/[^a-zA-Z0-9_]/g, '_');
                idMap[safe] = id;
                return safe;
            };

            const traverse = (currentId) => {
                if (visited.has(currentId)) return;
                visited.add(currentId);
                nodes.add(currentId);

                let children = [];

                // 1. Event Actions
                const eventDef = data.SibylSystemEvents?.Events?.[currentId];
                if (eventDef && eventDef.CountActions) {
                    children = eventDef.CountActions
                        .filter(act => act.ActionDefinitionId)
                        .map((act, i) => ({
                             to: act.ActionDefinitionId,
                             type: 'trigger',
                             label: null
                        }));
                }

                // 2. Action Definition Actions
                const actionDef = actionDefinitions[currentId];
                if (actionDef && actionDef.Actions) {
                    const actionChildren = actionDef.Actions
                        .map((act, idx) => {
                            if (act.Type === 'SibylAction' && act.ActionDefinitionId) {
                                return { to: act.ActionDefinitionId, type: 'link', label: idx + 1 };
                            }
                            if (act.Type === 'Glados2Event' && act.AwardId) {
                                return { to: `AWARD_${act.AwardId}`, type: 'award', label: 'Get' };
                            }
                            // Render Set/Reset/Counter Actions as steps
                            if (act.Type === 'SetCounter' || act.Type === 'ResetCounter' || act.CounterId) {
                                const stepId = `STEP_${currentId}_${idx}`;
                                idMap[getSafeId(stepId)] = stepId;
                                stepMeta[getSafeId(stepId)] = act;
                                return { to: stepId, type: 'step', label: idx + 1 };
                            }
                            return null;
                        })
                        .filter(Boolean);
                    children = [...children, ...actionChildren];
                }

                // No limit, just traverse everything
                children.forEach(edge => {
                    edges.push({ from: currentId, ...edge });
                    let targetId = edge.to;
                    if (targetId.startsWith('AWARD_')) {
                        nodes.add(targetId);
                    } else if (targetId.startsWith('STEP_')) {
                        nodes.add(targetId); 
                    } else {
                        traverse(targetId);
                    }
                });
            };

            traverse(rootId);

            if (nodes.size === 0) return { graph: '', nodeMap: {} };

            // Build Mermaid String
            let graph = `graph ${direction}\n`;
            
            graph += 'classDef event fill:#064e3b,stroke:#10b981,stroke-width:2px,color:white;\n';
            graph += 'classDef action fill:#4c1d95,stroke:#8b5cf6,stroke-width:2px,color:white;\n';
            graph += 'classDef award fill:#78350f,stroke:#f59e0b,stroke-width:2px,color:white,stroke-dasharray: 5 5;\n';
            graph += 'classDef missing fill:#7f1d1d,stroke:#f87171,stroke-width:2px,color:white,stroke-dasharray: 5 5;\n';
            graph += 'classDef step fill:#1e293b,stroke:#475569,stroke-width:1px,color:#94a3b8;\n'; 

            nodes.forEach(node => {
                const safeId = getSafeId(node);
                let label = node;
                let className = 'action';
                let clickEvent = `click ${safeId} callMermaidClick`;

                if (node.startsWith('AWARD_')) {
                    label = node.replace('AWARD_', 'üèÜ ');
                    className = 'award';
                } else if (node.startsWith('STEP_')) {
                    const raw = stepMeta[safeId];
                    if (raw) {
                         const icon = raw.Type === 'SetCounter' ? '‚úèÔ∏è' : (raw.Type === 'ResetCounter' ? 'üîÑ' : 'üîß');
                         const target = raw.CounterId ? raw.CounterId.split('-').pop() : '???';
                         label = `${icon} ${target}`;
                         
                         // Wrap long lines manually for svg
                         if (label.length > 30) {
                            label = label.substring(0, 30) + '...';
                         }
                    } else {
                        label = "Step";
                    }
                    className = 'step';
                } else if (data.SibylSystemEvents?.Events?.[node]) {
                    label = `üîî ${node}`;
                    className = 'event';
                } else if (actionDefinitions[node]) {
                    label = `‚ö° ${node}`;
                    className = 'action';
                } else {
                    label = `‚ùå ${node} (Missing)`;
                    className = 'missing';
                }
                
                // Truncate very long IDs for display in graph
                if (!node.startsWith('STEP_') && label.length > 50) {
                    label = label.substring(0, 47) + '...';
                }
                label = label.replace(/"/g, "'");

                graph += `${safeId}["${label}"]:::${className}\n`;
                graph += `${clickEvent}\n`;
            });

            edges.forEach(edge => {
                const from = getSafeId(edge.from);
                const to = getSafeId(edge.to);
                if (edge.type === 'award') {
                    graph += `${from} -.-> ${to}\n`;
                } else if (edge.label) {
                    graph += `${from} -->|${edge.label}| ${to}\n`;
                } else {
                    graph += `${from} --> ${to}\n`;
                }
            });

            return { graph, nodeMap: idMap };
        };

        const FlowchartView = ({ data, onNodeClick }) => {
            const [rootId, setRootId] = useState('');
            const [direction, setDirection] = useState('TD');
            const [graphData, setGraphData] = useState({ graph: '', nodeMap: {} });
            
            const mermaidRef = useRef(null);
            const nodeMapRef = useRef({}); 

            const roots = useMemo(() => {
                if (!data) return [];
                const events = Object.keys(data.SibylSystemEvents?.Events || {}).map(id => ({ id, type: 'Event' }));
                const actionDefs = { ...(data.SibylSystemCounters?.ActionDefinitions || {}), ...(data.ActionDefinitions || {}) };
                const actions = Object.keys(actionDefs).map(id => ({ id, type: 'Action' }));
                return [...events, ...actions].sort((a, b) => a.id.localeCompare(b.id));
            }, [data]);

            useEffect(() => {
                if (roots.length > 0 && !rootId) {
                    const defaultRoot = roots.find(r => r.id.toLowerCase().includes('init') || r.id.toLowerCase().includes('reset')) || roots[0];
                    setRootId(defaultRoot.id);
                }
            }, [roots]);

            useEffect(() => {
                if (rootId && data) {
                    const result = generateMermaidGraph(rootId, data, direction);
                    setGraphData(result);
                    nodeMapRef.current = result.nodeMap; 
                }
            }, [rootId, data, direction]);

            useEffect(() => {
                if (graphData.graph && mermaidRef.current) {
                    mermaidRef.current.innerHTML = ''; 
                    mermaid.render('mermaid-graph', graphData.graph).then(result => {
                        mermaidRef.current.innerHTML = result.svg;
                    });
                }
            }, [graphData.graph]);

            useEffect(() => {
                window.callMermaidClick = (safeId) => {
                    const originalId = nodeMapRef.current[safeId];
                    if (!originalId) return;
                    if (!originalId.startsWith('STEP_') && !originalId.startsWith('AWARD_')) {
                         onNodeClick(originalId);
                    }
                };
                return () => { delete window.callMermaidClick; };
            }, [onNodeClick]);

            return (
                <div className="h-full flex flex-col">
                    <div className="p-4 bg-slate-800 border-b border-slate-700 flex flex-wrap items-center gap-4">
                        <div className="flex items-center gap-2">
                             <label className="text-sm text-slate-400 font-bold">Flow Root:</label>
                            <select 
                                value={rootId} 
                                onChange={(e) => setRootId(e.target.value)}
                                className="bg-slate-900 text-white text-xs p-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none max-w-md"
                            >
                                {roots.map(r => (
                                    <option key={r.id} value={r.id}>
                                        [{r.type}] {r.id}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="flex bg-slate-900 rounded border border-slate-600 p-1">
                            <button 
                                onClick={() => setDirection('TD')}
                                className={`px-2 py-1 text-xs rounded ${direction === 'TD' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Top-Down
                            </button>
                            <button 
                                onClick={() => setDirection('LR')}
                                className={`px-2 py-1 text-xs rounded ${direction === 'LR' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Left-Right
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-hidden bg-slate-900 relative">
                         <PanZoomContainer contentKey={graphData.graph}>
                             <div ref={mermaidRef}></div>
                         </PanZoomContainer>
                         
                         {!graphData.graph && (
                             <div className="absolute inset-0 flex items-center justify-center text-slate-500">
                                 No flow detected for this root.
                             </div>
                         )}
                    </div>
                </div>
            );
        };

        const RawInput = ({ value, onChange, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-slate-900 w-full max-w-4xl h-[80vh] rounded-xl border border-slate-700 flex flex-col shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                            <div>
                                <h3 className="font-bold text-lg text-white">Paste Logic JSON</h3>
                                <p className="text-xs text-slate-400 font-mono mt-1">Paste the file content containing <span className="text-blue-400">"Events" -> "SeasonItems"</span></p>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white px-3 py-1 rounded hover:bg-slate-700 transition-colors">
                                Load & Visualize
                            </button>
                        </div>
                        <textarea
                            className="flex-grow bg-slate-950 text-green-400 font-mono text-xs p-4 focus:outline-none resize-none"
                            value={value}
                            onChange={(e) => onChange(e.target.value)}
                            placeholder='{ "Events": { "SeasonItems": [ ... ] } }'
                        />
                    </div>
                </div>
            );
        };

        // --- 5. Main Application ---

        const App = () => {
            const [jsonInput, setJsonInput] = useState("");
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);
            const [showInput, setShowInput] = useState(false);
            
            const [selectedSeason, setSelectedSeason] = useState(null);
            const [activeTab, setActiveTab] = useState('flowchart'); 
            const [searchTerm, setSearchTerm] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    setJsonInput(saved);
                    tryParse(saved, false);
                } else {
                    setShowInput(true);
                }
            }, []);

            const tryParse = (txt, save = true) => {
                try {
                    const parsed = JSON.parse(txt);
                    if (parsed.Events && parsed.Events.SeasonItems) {
                        setData(parsed);
                        setSelectedSeason(parsed.Events.SeasonItems[0]);
                        setError(null);
                        if (save) localStorage.setItem(STORAGE_KEY, txt);
                        setShowInput(false);
                    } else {
                        setError("Invalid JSON: Missing 'Events.SeasonItems' structure.");
                    }
                } catch (e) {
                    setError("Invalid JSON syntax: " + e.message);
                }
            };

            const handleLinkClick = (id) => {
                setActiveTab('actions');
                setSearchTerm(id);
                setTimeout(() => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.classList.add('ring-2', 'ring-yellow-400');
                        setTimeout(() => el.classList.remove('ring-2', 'ring-yellow-400'), 2000);
                    }
                }, 100);
            };

            const renderContent = () => {
                if (!selectedSeason) return null;

                if (activeTab === 'flowchart') {
                    return <FlowchartView data={selectedSeason} onNodeClick={handleLinkClick} />;
                }

                const filter = (obj) => {
                    if (!obj) return [];
                    const entries = Object.entries(obj);
                    if (!searchTerm) return entries;
                    const lower = searchTerm.toLowerCase();
                    return entries.filter(([k, v]) => 
                        k.toLowerCase().includes(lower) || 
                        JSON.stringify(v).toLowerCase().includes(lower)
                    );
                };

                switch (activeTab) {
                    case 'counters':
                        const counters = filter(selectedSeason.SibylSystemCounters?.Counters);
                        return (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6">
                                {counters.map(([id, def]) => <CounterCard key={id} id={id} def={def} />)}
                                {counters.length === 0 && <div className="text-slate-500 col-span-full text-center py-10">No counters found matching search.</div>}
                            </div>
                        );
                    case 'events':
                        const events = filter(selectedSeason.SibylSystemEvents?.Events);
                        return (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6">
                                {events.map(([id, def]) => <EventCard key={id} id={id} def={def} onLinkClick={handleLinkClick} />)}
                                {events.length === 0 && <div className="text-slate-500 col-span-full text-center py-10">No events found matching search.</div>}
                            </div>
                        );
                    case 'actions':
                        const allActions = {
                             ...(selectedSeason.SibylSystemCounters?.ActionDefinitions || {}),
                             ...(selectedSeason.ActionDefinitions || {})
                        };
                        const actions = filter(allActions);
                        return (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
                                {actions.map(([id, def]) => <ActionDefinitionCard key={id} id={id} def={def} onLinkClick={handleLinkClick} />)}
                                {actions.length === 0 && <div className="text-slate-500 col-span-full text-center py-10">No actions found matching search.</div>}
                            </div>
                        );
                    case 'tables':
                        const tables = filter(selectedSeason.ExpressionTables?.Tables);
                        return (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
                                {tables.map(([id, def]) => <TableCard key={id} id={id} def={def} />)}
                                {tables.length === 0 && <div className="text-slate-500 col-span-full text-center py-10">No tables found matching search.</div>}
                            </div>
                        );
                    default: return null;
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-slate-900 border-b border-slate-800 h-16 flex items-center justify-between px-6 sticky top-0 z-30 shadow-lg">
                        <div className="flex items-center gap-3">
                            <div className="text-2xl">üß†</div>
                            <div>
                                <h1 className="font-bold text-white leading-none">Sibyl Logic Inspector</h1>
                                {selectedSeason && <span className="text-xs text-blue-400 font-mono">{selectedSeason.SeasonItemId}</span>}
                            </div>
                        </div>

                        <div className="flex items-center gap-4">
                            {/* Search Bar (Hidden on Flowchart) */}
                            {activeTab !== 'flowchart' && (
                                <div className="relative hidden md:block">
                                    <input 
                                        type="text" 
                                        placeholder={`Search ${activeTab}...`}
                                        className="bg-slate-800 text-sm text-white px-3 py-1.5 pl-9 rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none w-64 transition-all placeholder-slate-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <span className="absolute left-2.5 top-2 text-slate-500 text-xs">üîé</span>
                                </div>
                            )}

                            <button 
                                onClick={() => setShowInput(true)}
                                className="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-2 rounded transition-colors"
                            >
                                Load JSON
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar Navigation */}
                        <aside className="w-16 md:w-48 bg-slate-900 border-r border-slate-800 flex-shrink-0 overflow-y-auto flex flex-col">
                            <div className="p-2 space-y-1 mt-2">
                                <button 
                                    onClick={() => setActiveTab('flowchart')}
                                    className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-3 ${activeTab === 'flowchart' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'text-slate-400 hover:bg-slate-800'}`}
                                >
                                    <span>üï∏Ô∏è</span> <span className="hidden md:inline">Flowchart</span>
                                </button>
                                <div className="h-px bg-slate-800 my-2"></div>
                                <button 
                                    onClick={() => setActiveTab('actions')}
                                    className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-3 ${activeTab === 'actions' ? 'bg-purple-900/30 text-purple-300 border border-purple-800/50' : 'text-slate-400 hover:bg-slate-800'}`}
                                >
                                    <span>‚ö°</span> <span className="hidden md:inline">Actions</span>
                                </button>
                                <button 
                                    onClick={() => setActiveTab('counters')}
                                    className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-3 ${activeTab === 'counters' ? 'bg-blue-900/30 text-blue-300 border border-blue-800/50' : 'text-slate-400 hover:bg-slate-800'}`}
                                >
                                    <span>üî¢</span> <span className="hidden md:inline">Counters</span>
                                </button>
                                <button 
                                    onClick={() => setActiveTab('events')}
                                    className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-3 ${activeTab === 'events' ? 'bg-emerald-900/30 text-emerald-300 border border-emerald-800/50' : 'text-slate-400 hover:bg-slate-800'}`}
                                >
                                    <span>üîî</span> <span className="hidden md:inline">Events</span>
                                </button>
                                <button 
                                    onClick={() => setActiveTab('tables')}
                                    className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-3 ${activeTab === 'tables' ? 'bg-orange-900/30 text-orange-300 border border-orange-800/50' : 'text-slate-400 hover:bg-slate-800'}`}
                                >
                                    <span>üìä</span> <span className="hidden md:inline">Tables</span>
                                </button>
                            </div>
                        </aside>

                        {/* Main Content Area */}
                        <main className="flex-1 overflow-y-auto bg-[#0f172a] relative">
                            {error && (
                                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-red-900/90 border border-red-500 text-white px-4 py-2 rounded shadow-xl z-50">
                                    {error}
                                </div>
                            )}

                            {!data && !error && (
                                <div className="h-full flex flex-col items-center justify-center text-slate-500">
                                    <div className="text-6xl mb-4">üß©</div>
                                    <p>No logic loaded.</p>
                                    <button onClick={() => setShowInput(true)} className="text-blue-400 hover:underline mt-2">Open Paste Window</button>
                                </div>
                            )}

                            {renderContent()}
                        </main>
                    </div>

                    {/* Modal */}
                    {showInput && (
                        <RawInput 
                            value={jsonInput} 
                            onChange={setJsonInput} 
                            onClose={() => tryParse(jsonInput)} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>