<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Deep Link QR Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind bg-gray-100 */
        }
        #qrcode img {
            margin: auto;
            display: block; /* Ensure it behaves as a block for margin auto to work */
        }
        #generatedUrl {
            word-break: break-all;
        }
        .param-group {
            border: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            padding: 1rem; /* Tailwind p-4 */
            margin-bottom: 1rem; /* Tailwind mb-4 */
            background-color: #ffffff; /* Tailwind bg-white */
        }
        .param-group label.block {
            font-weight: 500; /* Tailwind font-medium */
        }
        /* Ensure select dropdowns are visible in dark mode if user has it enabled */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 lg:p-8">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Advanced Deep Link QR Code Generator</h1>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-1/2 space-y-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Base Configuration</h2>
                    <div class="param-group">
                        <div>
                            <label for="environment" class="block text-sm font-medium text-gray-700 mb-1">Environment</label>
                            <select id="environment" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="trunk">Trunk (backend.jarvistrunk.net)</option>
                                <option value="trunkliveops">Trunk Liveops (don't use PR) (backend-liveops.jarvistrunk.net)</option>
                                <option value="qa3">QA3 (backend.liveops.jarvisqa.net)</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <label for="prNumber" class="block text-sm font-medium text-gray-700 mb-1">PR Number</label>
                            <input type="text" id="prNumber" value="" placeholder="e.g., 1234 (optional)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <p class="mt-1 text-xs text-gray-500">If provided, 'pr-' is prepended to form part of the backend_host. If blank, only the base environment URL is used for backend_host.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Additional Query Parameters ("Cheats")</h2>
                    <div id="additionalParamsContainer" class="space-y-4">
                        </div>
                </div>
                <div class="flex space-x-4 mt-8">
                     <button id="generateBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Generate QR Code & URL
                    </button>
                    <button id="resetBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Reset to Defaults
                    </button>
                </div>
            </div>

            <div class="lg:w-1/2 lg:sticky lg:top-8 space-y-6">
                 <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2 text-center">Scan QR Code</h2>
                    <div id="qrcode" class="p-4 border border-gray-300 rounded-lg bg-white shadow-sm w-64 h-64 sm:w-72 sm:h-72 mx-auto flex items-center justify-center">
                        </div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Generated Deep Link URL</h2>
                    <p id="generatedUrl" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md border border-gray-200 min-h-[60px]"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const environmentSelect = document.getElementById('environment');
        const prNumberInput = document.getElementById('prNumber');
        const additionalParamsContainer = document.getElementById('additionalParamsContainer');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const qrcodeDiv = document.getElementById('qrcode');
        const generatedUrlP = document.getElementById('generatedUrl');

        let qrCodeInstance = null;

        const environmentDomains = {
            trunk: "backend.jarvistrunk.net",
            trunkliveops: "backend-liveops.jarvistrunk.net",
            qa3: "backend.liveops.jarvisqa.net"
        };

        const LS_BASE_KEY = 'qrGenAdv_';
        const LS_KEYS = {
            ENVIRONMENT: LS_BASE_KEY + 'environment',
            PR_NUMBER: LS_BASE_KEY + 'prNumber',
            ADDITIONAL_PARAMS: LS_BASE_KEY + 'additionalParams'
        };

        const DEFAULTS = {
            ENVIRONMENT: 'trunk',
            PR_NUMBER: '',
        };

        const additionalParamsConfig = [
            { id: 'ava_dab', name: 'Ava DAB', key: 'ava_dab', type: 'text', placeholder: 'AVA_DAB value or reset', example: '?ava_dab=MY_DAB', defaultValue: '3_63_0' },
            { id: 'ava_header', name: 'Ava Header', key: 'ava_header', type: 'select', options: ['mvmx', 'mvmx-liveops'], example: '?ava_header=AVA_HEADER', defaultValue: 'mvmx' },
            { id: 'user_deviceid', name: 'User DeviceID', key: 'user_deviceid', type: 'text', placeholder: 'UDID', example: '?user_deviceid=UDID', defaultValue: '' },
            { id: 'user_adid', name: 'User AdvertisingID', key: 'user_adid', type: 'text', placeholder: 'ADID', example: '?user_adid=ADID', defaultValue: '' },
            { id: 'env_profile', name: 'Server Environment Profile', key: 'env_profile', type: 'select', options: ['trunk', 'qa1', 'qa3', 'stage', 'prod', 'reset'], example: '?env_profile=qa3', defaultValue: 'qa3' },
            { id: 'backend_pr', name: 'Backend PR (additional)', key: 'backend_pr', type: 'text', placeholder: 'e.g., 1024 or reset', example: '?backend_pr=1024', defaultValue: '' },
            { id: 'iap_cheat', name: 'IAP Cheat (no AppStore)', key: 'iap_cheat', type: 'select', options: ['true', 'false'], example: '?iap_cheat=true', defaultValue: 'false' },
            // Changed: Reset Device no longer has a text input, its value is fixed to "device" when enabled
            { id: 'reset_device', name: 'Reset Device', key: 'reset', type: 'checkbox_only', example: '?reset=device', fixedValue: 'device', defaultValue: false }, // defaultValue here refers to enabled state
            { id: 'nlog_level', name: 'NLog Console Log Level', key: 'nlog_level', type: 'select', options: ['debug', 'info', 'warn', 'error', 'fatal', 'off'], example: '?nlog_level=debug', defaultValue: 'info' },
            { id: 'auto_cheat', name: 'Auto Cheat', key: 'auto_cheat', type: 'text', placeholder: 'Cheat ID (e.g. SuperPlayer)', example: '?auto_cheat=SuperPlayer', defaultValue: '' }
        ];

        function renderAdditionalParams() {
            additionalParamsContainer.innerHTML = ''; 
            const savedParamsState = JSON.parse(localStorage.getItem(LS_KEYS.ADDITIONAL_PARAMS) || '{}');

            additionalParamsConfig.forEach(param => {
                const isDefaultEnabled = (param.id === 'ava_dab' || param.id === 'ava_header' || (param.type === 'checkbox_only' && param.defaultValue === true) );
                // For checkbox_only, param.defaultValue refers to its enabled state.
                // For others, param.defaultValue refers to the input's value, and enabled is separate.
                let initialEnabledState = isDefaultEnabled;
                let initialValue = param.defaultValue;

                if (savedParamsState[param.id]) {
                    initialEnabledState = savedParamsState[param.id].enabled;
                    if (param.type !== 'checkbox_only') { // checkbox_only doesn't have a separate value to save/load
                        initialValue = savedParamsState[param.id].value;
                    }
                }


                const wrapper = document.createElement('div');
                wrapper.className = 'param-group';

                let inputHtml = '';
                // Only render input fields for types that require them
                if (param.type === 'text') {
                    inputHtml = `<input type="text" id="${param.id}_value" value="${initialValue}" placeholder="${param.placeholder || ''}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" ${!initialEnabledState ? 'disabled' : ''}>`;
                } else if (param.type === 'select') {
                    const optionsHtml = param.options.map(opt => `<option value="${opt}" ${opt === initialValue ? 'selected' : ''}>${opt}</option>`).join('');
                    inputHtml = `<select id="${param.id}_value" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" ${!initialEnabledState ? 'disabled' : ''}>${optionsHtml}</select>`;
                }
                // For 'checkbox_only', inputHtml remains empty as the checkbox itself is the primary control.

                wrapper.innerHTML = `
                    <div class="flex items-center justify-between">
                        <label for="${param.id}_enable" class="block text-sm font-medium text-gray-900">${param.name}</label>
                        <input type="checkbox" id="${param.id}_enable" ${initialEnabledState ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    </div>
                    ${inputHtml} 
                    ${param.example ? `<p class="mt-1 text-xs text-gray-500">${param.example}</p>` : ''}
                `;
                additionalParamsContainer.appendChild(wrapper);

                const enableCheckbox = document.getElementById(`${param.id}_enable`);
                enableCheckbox.addEventListener('change', (e) => {
                    if (param.type !== 'checkbox_only') {
                        document.getElementById(`${param.id}_value`).disabled = !e.target.checked;
                    }
                    generateAndDisplayQrCode();
                });

                if (param.type !== 'checkbox_only') {
                    const valueElement = document.getElementById(`${param.id}_value`);
                    valueElement.addEventListener('input', generateAndDisplayQrCode); 
                    if(param.type === 'select') { 
                        valueElement.addEventListener('change', generateAndDisplayQrCode);
                    }
                }
            });
        }

        function saveInputsToLocalStorage() {
            localStorage.setItem(LS_KEYS.ENVIRONMENT, environmentSelect.value);
            localStorage.setItem(LS_KEYS.PR_NUMBER, prNumberInput.value);

            const additionalParamsState = {};
            additionalParamsConfig.forEach(param => {
                const enableCheckbox = document.getElementById(`${param.id}_enable`);
                additionalParamsState[param.id] = {
                    enabled: enableCheckbox.checked,
                    // For checkbox_only, value is not user-editable, so we don't try to get it from a non-existent input.
                    // The fixedValue is used during URL generation.
                    value: (param.type !== 'checkbox_only' && enableCheckbox.checked) ? document.getElementById(`${param.id}_value`).value : (param.fixedValue || '')
                };
            });
            localStorage.setItem(LS_KEYS.ADDITIONAL_PARAMS, JSON.stringify(additionalParamsState));
        }

        function loadInputsFromLocalStorage() {
            environmentSelect.value = localStorage.getItem(LS_KEYS.ENVIRONMENT) || DEFAULTS.ENVIRONMENT;
            prNumberInput.value = localStorage.getItem(LS_KEYS.PR_NUMBER) || DEFAULTS.PR_NUMBER;
        }

        function resetToDefaultSettings() {
            Object.values(LS_KEYS).forEach(key => localStorage.removeItem(key));
            environmentSelect.value = DEFAULTS.ENVIRONMENT;
            prNumberInput.value = DEFAULTS.PR_NUMBER;
            renderAdditionalParams(); // This will now use hardcoded defaults for additional params
            generateAndDisplayQrCode();
        }

        function generateAndDisplayQrCode() {
            const selectedEnvironment = environmentSelect.value;
            const prNumber = prNumberInput.value.trim();
            
            let backendHost;
            const baseDomain = environmentDomains[selectedEnvironment];
            if (prNumber) {
                backendHost = `pr-${prNumber}.${baseDomain}`;
            } else {
                backendHost = baseDomain;
            }

            let queryParams = [`backend_host=${encodeURIComponent(backendHost)}`];

            additionalParamsConfig.forEach(param => {
                const enableCheckbox = document.getElementById(`${param.id}_enable`);
                if (enableCheckbox && enableCheckbox.checked) {
                    let value;
                    if (param.type === 'checkbox_only') {
                        value = param.fixedValue; // Use the fixed value
                    } else {
                        const valueInput = document.getElementById(`${param.id}_value`);
                        value = valueInput ? valueInput.value.trim() : '';
                    }
                    
                    // Only add param if it has a value, or if it's a type that should always be included when enabled (like checkbox_only)
                    // or specific keys like ava_dab/ava_header.
                    if (value !== '' || param.type === 'checkbox_only' || param.key === 'ava_dab' || param.key === 'ava_header') {
                        queryParams.push(`${encodeURIComponent(param.key)}=${encodeURIComponent(value)}`);
                    }
                }
            });
            
            const deepLinkUrl = `myvegas-slots://slots/action?${queryParams.join('&')}`;
            generatedUrlP.textContent = deepLinkUrl;
            qrcodeDiv.innerHTML = '';

            try {
                qrCodeInstance = new QRCode(qrcodeDiv, {
                    text: deepLinkUrl,
                    width: qrcodeDiv.offsetWidth > 20 ? qrcodeDiv.offsetWidth - 10 : 256, 
                    height: qrcodeDiv.offsetHeight > 20 ? qrcodeDiv.offsetHeight - 10 : 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                if (!resetBtn.dataset.isResetting) { 
                     saveInputsToLocalStorage();
                }
            } catch (e) {
                console.error("QR Code generation error:", e);
                qrcodeDiv.innerHTML = 'Error generating QR code.';
            }
        }

        generateBtn.addEventListener('click', generateAndDisplayQrCode);
        resetBtn.addEventListener('click', () => {
            resetBtn.dataset.isResetting = true; 
            resetToDefaultSettings();
            delete resetBtn.dataset.isResetting; 
        });
        environmentSelect.addEventListener('change', generateAndDisplayQrCode);
        prNumberInput.addEventListener('input', generateAndDisplayQrCode);

        window.addEventListener('load', () => {
            loadInputsFromLocalStorage(); 
            renderAdditionalParams();     
            generateAndDisplayQrCode();   

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(generateAndDisplayQrCode, 250);
            });
        });
    </script>
</body>
</html>
